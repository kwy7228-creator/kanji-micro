<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Kanji Micro · 200 (JPT 750)</title>
  <style>
    :root { color-scheme: light; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans JP", sans-serif; background:#f7f5f2; color:#141821; }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 18px; }
    header { display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between; }
    h1 { margin:0; font-size:18px; }
    .muted { color:#6b7280; font-size:12px; line-height:1.4; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .pill { font-size:12px; padding:6px 10px; border:1px solid #e1dbd3; border-radius:999px; background:#fff; }
    .btn { border:0; padding:10px 12px; border-radius:10px; background:#2f6fed; color:#fff; cursor:pointer; font-weight:800; }
    .btn.secondary { background:#111827; }
    .btn.ghost { background:#fff; color:#111827; border:1px solid #d9d2c8; }
    .btn:disabled { opacity:.5; cursor:not-allowed; }

    .tabs { display:flex; gap:8px; flex-wrap:wrap; margin-top:12px; }
    .tab { border:1px solid #d9d2c8; background:#fff; padding:8px 10px; border-radius:10px; cursor:pointer; font-weight:800; }
    .tab.active { background:#1f2937; color:#fff; border-color:#1f2937; }

    .grid { display:grid; grid-template-columns: 1fr; gap:14px; margin-top:14px; }
    @media (min-width: 920px){ .grid { grid-template-columns: 1fr 1fr; } }

    .card { background:#fff; border:1px solid #e6dfd7; border-radius:14px; padding:16px; box-shadow: 0 6px 18px rgba(0,0,0,.06); }
    .kanjiRow { display:flex; gap:14px; align-items:flex-end; flex-wrap:wrap; }
    .kanji { font-size:64px; line-height:1; font-weight:900; }
    .meta { display:flex; flex-direction:column; gap:6px; }
    .meta .small { font-size:12px; color:#5a6475; }

    .section { margin-top: 12px; display:grid; gap:10px; }
    .label { font-size:12px; color:#6b7280; font-weight:900; letter-spacing:.08em; text-transform: uppercase; }
    .item { background:#fbfaf8; border:1px solid #eee7df; border-radius:12px; padding:10px 12px; }
    .jp { font-size:15px; font-weight:900; }
    .sub { font-size:13px; color:#4b5563; margin-top:4px; }

    .quizBox { display:grid; gap:12px; }
    .q { font-weight:900; white-space:pre-wrap; }
    .choices { display:grid; gap:8px; margin-top:8px; }
    .choice { text-align:left; background:#fff; border:1px solid #e6dfd7; padding:10px 12px; border-radius:10px; cursor:pointer; font-weight:900; }
    .choice.correct { border-color:#16a34a; outline:2px solid rgba(22,163,74,.2); }
    .choice.wrong { border-color:#dc2626; outline:2px solid rgba(220,38,38,.2); }

    code { background:#f3f4f6; padding:2px 6px; border-radius:6px; }
    .footer { margin-top: 16px; font-size:12px; color:#6b7280; line-height:1.5; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Kanji Micro · 200 (JPT 750)</h1>
        <div class="muted">한자 → 단어 → 문장 → 문장 듣기 · 최근 5일 복습 퀴즈 · 파트5 빈칸</div>
      </div>
      <div class="row">
        <span id="todayPill" class="pill"></span>
        <button id="regenBtn" class="btn">오늘 3개 다시뽑기</button>
        <button id="ttsBtn" class="btn ghost">TTS 테스트</button>
      </div>
    </header>

    <div class="tabs">
      <button class="tab active" data-tab="learn">학습</button>
      <button class="tab" data-tab="review">복습(최근 5일)</button>
      <button class="tab" data-tab="part5">파트5 빈칸</button>
      <button class="tab" data-tab="settings">설정</button>
    </div>

    <main id="view"></main>

    <div class="footer">
      - 오늘의 3한자는 “날짜 기반으로 자동 고정”됩니다(저장 지워도 동일).<br/>
      - 복습 기록은 브라우저 <code>localStorage</code>에 저장됩니다(PC/브라우저 바뀌면 초기화될 수 있음).
    </div>
  </div>

<script>
/* =========================
   0) 유틸
   ========================= */
function uniq(arr){ return Array.from(new Set(arr)); }
function shuffle(arr){
  const a = arr.slice();
  for (let i=a.length-1; i>0; i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}
function escapeHtml(str){
  return String(str)
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;")
    .replace(/'/g,"&#039;");
}
function escapeAttr(str){ return escapeHtml(str).replace(/"/g,"&quot;"); }

/* =========================
   1) 200개 한자 + 음독/훈독/의미(초급~중급 범위)
   - 필요하면 여기 내용을 계속 확장하면 됨
   ========================= */
const KANJI_INFO = {
  "日":{on:"ニチ / ジツ",kun:"ひ / び / か",m:"날, 해"},
  "月":{on:"ゲツ / ガツ",kun:"つき",m:"달"},
  "火":{on:"カ",kun:"ひ / ほ",m:"불"},
  "水":{on:"スイ",kun:"みず",m:"물"},
  "木":{on:"モク / ボク",kun:"き / こ",m:"나무"},
  "金":{on:"キン / コン",kun:"かね / かな",m:"돈, 금"},
  "土":{on:"ド / ト",kun:"つち",m:"흙"},
  "年":{on:"ネン",kun:"とし",m:"해, 나이"},
  "今":{on:"コン",kun:"いま",m:"지금"},
  "時":{on:"ジ",kun:"とき",m:"때, 시간"},
  "分":{on:"ブン / フン",kun:"わ(ける) / わ(かる)",m:"나누다, 분"},
  "先":{on:"セン",kun:"さき",m:"먼저, 앞"},
  "後":{on:"ゴ / コウ",kun:"あと / うし(ろ)",m:"뒤, 후"},
  "前":{on:"ゼン",kun:"まえ",m:"앞"},
  "間":{on:"カン / ケン",kun:"あいだ / ま",m:"사이, 동안"},
  "半":{on:"ハン",kun:"なか(ば)",m:"반"},
  "毎":{on:"マイ",kun:"ごと(に)",m:"매, 매번"},
  "朝":{on:"チョウ",kun:"あさ",m:"아침"},
  "昼":{on:"チュウ",kun:"ひる",m:"낮"},
  "夜":{on:"ヤ",kun:"よる / よ",m:"밤"},

  "人":{on:"ジン / ニン",kun:"ひと",m:"사람"},
  "男":{on:"ダン / ナン",kun:"おとこ",m:"남자"},
  "女":{on:"ジョ / ニョ",kun:"おんな / め",m:"여자"},
  "子":{on:"シ / ス",kun:"こ",m:"아이"},
  "友":{on:"ユウ",kun:"とも",m:"친구"},
  "私":{on:"シ",kun:"わたし / わたくし",m:"나, 사"},
  "彼":{on:"ヒ",kun:"かれ",m:"그, 남자친구"},
  "家":{on:"カ / ケ",kun:"いえ / や",m:"집, 가"},
  "母":{on:"ボ",kun:"はは",m:"어머니"},
  "父":{on:"フ",kun:"ちち",m:"아버지"},
  "兄":{on:"ケイ / キョウ",kun:"あに",m:"형/오빠"},
  "姉":{on:"シ",kun:"あね",m:"누나/언니"},
  "弟":{on:"テイ / ダイ",kun:"おとうと",m:"남동생"},
  "妹":{on:"マイ",kun:"いもうと",m:"여동생"},
  "名":{on:"メイ / ミョウ",kun:"な",m:"이름"},
  "方":{on:"ホウ",kun:"かた",m:"방향, 분(사람)"},
  "国":{on:"コク",kun:"くに",m:"나라"},
  "外":{on:"ガイ / ゲ",kun:"そと / はず(す)",m:"밖, 외"},
  "京":{on:"キョウ / ケイ",kun:"みやこ",m:"수도, 경"},
  "市":{on:"シ",kun:"いち",m:"시(도시), 시장"},
  "大":{on:"ダイ / タイ",kun:"おお(きい)",m:"크다"},
  "小":{on:"ショウ",kun:"ちい(さい) / こ",m:"작다"},
  "多":{on:"タ",kun:"おお(い)",m:"많다"},
  "少":{on:"ショウ",kun:"すこ(し) / すく(ない)",m:"적다, 조금"},
  "新":{on:"シン",kun:"あたら(しい) / あら(た)",m:"새롭다"},
  "古":{on:"コ",kun:"ふる(い)",m:"오래되다"},
  "長":{on:"チョウ",kun:"なが(い)",m:"길다, 장"},
  "短":{on:"タン",kun:"みじか(い)",m:"짧다"},
  "高":{on:"コウ",kun:"たか(い)",m:"높다/비싸다"},
  "安":{on:"アン",kun:"やす(い)",m:"싸다, 편안"},
  "強":{on:"キョウ",kun:"つよ(い)",m:"강하다"},
  "弱":{on:"ジャク",kun:"よわ(い)",m:"약하다"},
  "早":{on:"ソウ / サッ",kun:"はや(い) / はや(まる)",m:"빠르다, 이르다"},
  "遅":{on:"チ",kun:"おそ(い) / おく(れる)",m:"늦다"},
  "明":{on:"メイ / ミョウ",kun:"あか(るい) / あき(らか)",m:"밝다, 명"},
  "暗":{on:"アン",kun:"くら(い)",m:"어둡다"},
  "楽":{on:"ラク / ガク",kun:"たの(しい)",m:"즐겁다, 악"},
  "苦":{on:"ク",kun:"くる(しい) / にが(い)",m:"괴롭다, 쓰다"},
  "近":{on:"キン",kun:"ちか(い)",m:"가깝다"},
  "遠":{on:"エン / オン",kun:"とお(い)",m:"멀다"},

  "上":{on:"ジョウ",kun:"うえ / あ(がる)",m:"위, 오르다"},
  "下":{on:"カ / ゲ",kun:"した / さ(がる)",m:"아래, 내려가다"},
  "左":{on:"サ",kun:"ひだり",m:"왼쪽"},
  "右":{on:"ウ / ユウ",kun:"みぎ",m:"오른쪽"},
  "中":{on:"チュウ",kun:"なか",m:"가운데"},
  "内":{on:"ナイ",kun:"うち",m:"안, 내부"},
  "入":{on:"ニュウ",kun:"い(る) / はい(る)",m:"들어가다"},
  "出":{on:"シュツ",kun:"で(る) / だ(す)",m:"나가다, 내다"},
  "行":{on:"コウ / ギョウ",kun:"い(く) / おこな(う)",m:"가다, 행하다"},
  "来":{on:"ライ",kun:"く(る)",m:"오다"},
  "帰":{on:"キ",kun:"かえ(る)",m:"돌아가다"},
  "歩":{on:"ホ / ブ",kun:"ある(く)",m:"걷다"},
  "走":{on:"ソウ",kun:"はし(る)",m:"달리다"},
  "見":{on:"ケン",kun:"み(る)",m:"보다"},
  "聞":{on:"ブン / モン",kun:"き(く)",m:"듣다, 묻다"},
  "言":{on:"ゲン / ゴン",kun:"い(う) / こと",m:"말하다, 말"},
  "話":{on:"ワ",kun:"はな(す) / はなし",m:"말하다, 이야기"},
  "読":{on:"ドク",kun:"よ(む)",m:"읽다"},
  "書":{on:"ショ",kun:"か(く)",m:"쓰다, 서"},
  "食":{on:"ショク",kun:"た(べる)",m:"먹다"},
  "飲":{on:"イン",kun:"の(む)",m:"마시다"},
  "買":{on:"バイ",kun:"か(う)",m:"사다"},
  "売":{on:"バイ",kun:"う(る)",m:"팔다"},
  "作":{on:"サク / サ",kun:"つく(る)",m:"만들다"},
  "使":{on:"シ",kun:"つか(う)",m:"쓰다(사용)"},
  "持":{on:"ジ",kun:"も(つ)",m:"가지다"},
  "取":{on:"シュ",kun:"と(る)",m:"잡다, 취하다"},
  "置":{on:"チ",kun:"お(く)",m:"두다"},
  "立":{on:"リツ",kun:"た(つ)",m:"서다"},
  "座":{on:"ザ",kun:"すわ(る)",m:"앉다"},
  "休":{on:"キュウ",kun:"やす(む)",m:"쉬다"},
  "働":{on:"ドウ",kun:"はたら(く)",m:"일하다"},
  "教":{on:"キョウ",kun:"おし(える)",m:"가르치다"},
  "習":{on:"シュウ",kun:"なら(う)",m:"익히다"},
  "学":{on:"ガク",kun:"まな(ぶ)",m:"배우다"},
  "校":{on:"コウ",kun:"—",m:"학교"},
  "試":{on:"シ",kun:"ため(す)",m:"시험, 시험하다"},
  "験":{on:"ケン",kun:"—",m:"시험/경험(검)"},
  "合":{on:"ゴウ",kun:"あ(う)",m:"맞다, 합"},
  "格":{on:"カク",kun:"—",m:"격, 자격"},

  /* 아래는 직장/문서/업무에서 자주 쓰는 200 구성(의미는 한국어로 간단히) */
  "会":{on:"カイ",kun:"あ(う)",m:"만나다, 회"},
  "社":{on:"シャ",kun:"やしろ",m:"회사, 사"},
  "員":{on:"イン",kun:"—",m:"구성원"},
  "部":{on:"ブ",kun:"—",m:"부서, 부분"},
  "課":{on:"カ",kun:"—",m:"과, 과제"},
  "同":{on:"ドウ",kun:"おな(じ)",m:"같다"},
  "関":{on:"カン",kun:"せき",m:"관계, 관"},
  "係":{on:"ケイ",kun:"かか(る)",m:"담당, 관계"},
  "議":{on:"ギ",kun:"—",m:"의논"},
  "計":{on:"ケイ",kun:"はか(る)",m:"계획, 재다"},
  "画":{on:"ガ / カク",kun:"—",m:"그림, 획"},
  "案":{on:"アン",kun:"—",m:"안(제안/초안)"},
  "実":{on:"ジツ",kun:"み / みの(る)",m:"실제"},
  "施":{on:"シ",kun:"ほどこ(す)",m:"시행"},
  "定":{on:"テイ",kun:"さだ(める)",m:"정하다"},
  "決":{on:"ケツ",kun:"き(める)",m:"결정하다"},
  "要":{on:"ヨウ",kun:"い(る)",m:"필요"},
  "必":{on:"ヒツ",kun:"—",m:"반드시"},
  "確":{on:"カク",kun:"たし(か)",m:"확실"},
  "認":{on:"ニン",kun:"みと(める)",m:"인정/확인"},
  "報":{on:"ホウ",kun:"むく(いる)",m:"보고/보상"},
  "連":{on:"レン",kun:"つら(なる)",m:"연락/연결"},
  "相":{on:"ソウ / ショウ",kun:"あい",m:"상, 서로"},
  "資":{on:"シ",kun:"—",m:"자원/자본"},
  "料":{on:"リョウ",kun:"—",m:"자료/요금"},
  "提":{on:"テイ",kun:"さ(げる)",m:"제시"},
  "供":{on:"キョウ / ク",kun:"とも",m:"제공/공급"},
  "受":{on:"ジュ",kun:"う(ける)",m:"받다"},
  "付":{on:"フ",kun:"つ(ける)",m:"붙이다/부여"},
  "送":{on:"ソウ",kun:"おく(る)",m:"보내다"},
  "達":{on:"タツ",kun:"—",m:"도달/전달"},
  "配":{on:"ハイ",kun:"くば(る)",m:"배분/배달"},
  "備":{on:"ビ",kun:"そな(える)",m:"준비/비"},
  "整":{on:"セイ",kun:"ととの(える)",m:"정리/정비"},
  "理":{on:"リ",kun:"—",m:"이치/관리"},
  "改":{on:"カイ",kun:"あらた(める)",m:"개정/개선"},
  "善":{on:"ゼン",kun:"よ(い)",m:"좋다/개선"},
  "増":{on:"ゾウ",kun:"ふ(える)",m:"늘다"},
  "減":{on:"ゲン",kun:"へ(る)",m:"줄다"},
  "費":{on:"ヒ",kun:"つい(やす)",m:"비용"},
  "利":{on:"リ",kun:"き(く)",m:"이익/편리"},
  "損":{on:"ソン",kun:"そこ(なう)",m:"손해"},
  "得":{on:"トク",kun:"え(る)",m:"얻다"},
  "価":{on:"カ",kun:"あたい",m:"가치/가격"},
  "額":{on:"ガク",kun:"ひたい",m:"액수/이마"},
  "率":{on:"リツ",kun:"—",m:"비율"},
  "比":{on:"ヒ",kun:"くら(べる)",m:"비교"},
  "較":{on:"カク",kun:"—",m:"비교(較)"},
  "選":{on:"セン",kun:"えら(ぶ)",m:"선택하다"},
  "択":{on:"タク",kun:"—",m:"고르다(택)"},
  "例":{on:"レイ",kun:"たと(える)",m:"예, 사례"},
  "像":{on:"ゾウ",kun:"—",m:"상/영상"},
  "形":{on:"ケイ / ギョウ",kun:"かたち",m:"모양"},
  "点":{on:"テン",kun:"—",m:"점"},
  "線":{on:"セン",kun:"—",m:"선"},
  "面":{on:"メン",kun:"おも / つら",m:"면"},
  "章":{on:"ショウ",kun:"—",m:"장(章)"},
  "題":{on:"ダイ",kun:"—",m:"제목/문제"},
  "問":{on:"モン",kun:"と(う)",m:"묻다/문제"},
  "答":{on:"トウ",kun:"こた(える)",m:"대답"},
  "練":{on:"レン",kun:"ね(る)",m:"연습/단련"},
  "説":{on:"セツ",kun:"と(く)",m:"설명"},
  "明":{on:"メイ / ミョウ",kun:"あか(るい)",m:"밝다/명"},
  "意":{on:"イ",kun:"—",m:"의미/의도"},
  "味":{on:"ミ",kun:"あじ",m:"맛/의미"},
  "思":{on:"シ",kun:"おも(う)",m:"생각하다"},
  "考":{on:"コウ",kun:"かんが(える)",m:"고려하다"},
  "感":{on:"カン",kun:"—",m:"느낌"},
  "情":{on:"ジョウ",kun:"なさ(け)",m:"감정/정"},
  "心":{on:"シン",kun:"こころ",m:"마음"},
  "頭":{on:"トウ",kun:"あたま",m:"머리"},
  "体":{on:"タイ",kun:"からだ",m:"몸"},
  "病":{on:"ビョウ",kun:"やまい",m:"병"},
  "医":{on:"イ",kun:"—",m:"의사/의료"},
  "薬":{on:"ヤク",kun:"くすり",m:"약"},
  "運":{on:"ウン",kun:"はこ(ぶ)",m:"운반/운"},
  "動":{on:"ドウ",kun:"うご(く)",m:"움직이다"},
  "旅":{on:"リョ",kun:"たび",m:"여행"},
  "館":{on:"カン",kun:"やかた",m:"관(건물)"},
  "車":{on:"シャ",kun:"くるま",m:"차"},
  "駅":{on:"エキ",kun:"—",m:"역"},
  "空":{on:"クウ",kun:"そら / あ(く)",m:"하늘/비다"},
  "港":{on:"コウ",kun:"みなと",m:"항구"},
  "道":{on:"ドウ",kun:"みち",m:"길/도"},
  "橋":{on:"キョウ",kun:"はし",m:"다리(교량)"},
  "電":{on:"デン",kun:"—",m:"전기"},
  "気":{on:"キ / ケ",kun:"—",m:"기운/마음"},
  "力":{on:"リョク / リキ",kun:"ちから",m:"힘"},
  "音":{on:"オン",kun:"おと / ね",m:"소리"},
  "声":{on:"セイ",kun:"こえ",m:"목소리"},
  "写":{on:"シャ",kun:"うつ(す)",m:"베끼다/찍다"},
  "真":{on:"シン",kun:"ま",m:"진짜"},
  "映":{on:"エイ",kun:"うつ(る)",m:"비치다"},
  "画":{on:"ガ / カク",kun:"—",m:"그림/영상"},
  "歌":{on:"カ",kun:"うた",m:"노래"},
  "英":{on:"エイ",kun:"—",m:"영국/영"},
  "語":{on:"ゴ",kun:"かた(る)",m:"말/언어"},
  "数":{on:"スウ",kun:"かず",m:"수, 숫자"},
  "理":{on:"リ",kun:"—",m:"이치/이과"}
};

/* 200 리스트(표시 순서용) */
const KANJI_LIST_200 = Object.keys(KANJI_INFO);

/* =========================
   2) “단어/문장/파트5” 템플릿 생성
   (나중에 실제 단어/예문 DB로 교체하기 쉬운 구조 유지)
   ========================= */
function buildEntry(k){
  const info = KANJI_INFO[k] || {on:"-",kun:"-",m:"-"};
  const words = [
    {jp: k + "語", y:"-", kr:"관련 단어(예시)"},
    {jp: k + "学", y:"-", kr:"관련 단어(예시)"},
    {jp: "基" + k, y:"-", kr:"관련 단어(예시)"}
  ];
  const sentences = [
    {jp: "この" + k + "は重要です。", kr: "이 " + k + "는 중요합니다."},
    {jp: k + "について説明します。", kr: k + "에 대해 설명하겠습니다."}
  ];
  const choices = shuffle([
    "（" + k + "）",
    "（" + pickOther(k) + "）",
    "（" + pickOther(k) + "）",
    "（" + pickOther(k) + "）"
  ]).slice(0,4);

  const cloze = [{
    q: "この（　）は重要です。",
    a: "（" + k + "）",
    choices,
    kr: "이 ( )는 중요합니다."
  }];

  return {
    k,
    y_on: info.on,
    y_kun: info.kun,
    m: info.m,
    words,
    sentences,
    cloze
  };
}
function pickOther(exceptK){
  let other = exceptK;
  for (let i=0; i<10 && other === exceptK; i++){
    other = KANJI_LIST_200[Math.floor(Math.random()*KANJI_LIST_200.length)];
  }
  return other;
}
const KANJI_DB = KANJI_LIST_200.map(buildEntry);
function lookupByK(k){ return KANJI_DB.find(x=>x.k===k); }

/* =========================
   3) 날짜 기반 “결정적” 오늘의 3한자
   - 날짜가 같으면 항상 같은 3개
   - (옵션) 버튼으로 “랜덤 다시뽑기” 가능
   ========================= */
const LS_HISTORY_KEY = "KANJI_APP_HISTORY_V2";  // 기록 저장
const LS_OVERRIDE_KEY = "KANJI_APP_OVERRIDE_V1"; // 날짜별 강제세트(버튼으로 다시뽑기 했을 때)

function kstDateKey(offsetDays=0){
  const now = new Date();
  const utc = now.getTime() + now.getTimezoneOffset()*60000;
  const kst = new Date(utc + 9*3600000);
  kst.setDate(kst.getDate() + offsetDays);
  const y = kst.getFullYear();
  const m = String(kst.getMonth()+1).padStart(2,"0");
  const d = String(kst.getDate()).padStart(2,"0");
  return y + "-" + m + "-" + d;
}
function loadJSON(key, fallback){
  try { return JSON.parse(localStorage.getItem(key) || JSON.stringify(fallback)); }
  catch { return fallback; }
}
function saveJSON(key, obj){
  localStorage.setItem(key, JSON.stringify(obj));
}

function hash32(str){
  // 간단한 해시(결정적 랜덤용)
  let h = 2166136261;
  for (let i=0; i<str.length; i++){
    h ^= str.charCodeAt(i);
    h = Math.imul(h, 16777619);
  }
  return h >>> 0;
}
function seededPick3(dateKey){
  const seed = hash32(dateKey);
  const idxs = [];
  const n = KANJI_LIST_200.length;
  let x = seed;
  while (idxs.length < 3){
    // xorshift-ish
    x ^= x << 13; x >>>= 0;
    x ^= x >> 17; x >>>= 0;
    x ^= x << 5;  x >>>= 0;
    const idx = x % n;
    if (!idxs.includes(idx)) idxs.push(idx);
  }
  return idxs.map(i => KANJI_LIST_200[i]);
}

function saveStudyHistory(dateKey, ks){
  const hist = loadJSON(LS_HISTORY_KEY, {});
  hist[dateKey] = ks;
  saveJSON(LS_HISTORY_KEY, hist);
}
function getTodaySet(){
  const dateKey = kstDateKey(0);

  // 1) 버튼으로 “오늘 다시뽑기” 한 경우가 있으면 그걸 우선
  const override = loadJSON(LS_OVERRIDE_KEY, {});
  if (override[dateKey] && Array.isArray(override[dateKey]) && override[dateKey].length === 3){
    saveStudyHistory(dateKey, override[dateKey]);
    return override[dateKey];
  }

  // 2) 기본: 날짜 기반 고정 3개
  const ks = seededPick3(dateKey);
  saveStudyHistory(dateKey, ks);
  return ks;
}
function regenTodayRandom(){
  const dateKey = kstDateKey(0);
  const ks = shuffle(KANJI_LIST_200).slice(0,3);
  const override = loadJSON(LS_OVERRIDE_KEY, {});
  override[dateKey] = ks;
  saveJSON(LS_OVERRIDE_KEY, override);
  saveStudyHistory(dateKey, ks);
  return ks;
}
function getRecentDays(n=5){
  const keys = [];
  for (let i=0; i<n; i++){
    keys.push(kstDateKey(-i));
  }
  return keys;
}

/* =========================
   4) TTS
   ========================= */
function speakJP(text){
  if (!("speechSynthesis" in window)) { alert("이 브라우저는 TTS를 지원하지 않습니다."); return; }
  const u = new SpeechSynthesisUtterance(text);
  u.lang = "ja-JP";
  window.speechSynthesis.cancel();
  window.speechSynthesis.speak(u);
}
window.speakJP = speakJP;

/* =========================
   5) 렌더
   ========================= */
const view = document.getElementById("view");
const todayPill = document.getElementById("todayPill");

function renderLearn(){
  const dateKey = kstDateKey(0);
  todayPill.textContent = "오늘: " + dateKey + " · 3한자(날짜고정)";

  const ks = getTodaySet();
  const items = ks.map(lookupByK).filter(Boolean);

  view.innerHTML =
    '<div class="grid">' +
    items.map(item =>
      '<div class="card">' +
        '<div class="kanjiRow">' +
          '<div class="kanji">' + escapeHtml(item.k) + '</div>' +
          '<div class="meta">' +
            '<div class="small"><b>음독</b> ' + escapeHtml(item.y_on||"-") + '</div>' +
            '<div class="small"><b>훈독</b> ' + escapeHtml(item.y_kun||"-") + '</div>' +
            '<div class="small"><b>의미</b> ' + escapeHtml(item.m||"-") + '</div>' +
          '</div>' +
        '</div>' +

        '<div class="section">' +
          '<div class="label">단어</div>' +
          (item.words||[]).slice(0,3).map(w =>
            '<div class="item">' +
              '<div class="jp">' + escapeHtml(w.jp) + '（' + escapeHtml(w.y) + '）</div>' +
              '<div class="sub">' + escapeHtml(w.kr||"") + '</div>' +
            '</div>'
          ).join("") +
        '</div>' +

        '<div class="section">' +
          '<div class="label">문장</div>' +
          (item.sentences||[]).slice(0,2).map(s =>
            '<div class="item">' +
              '<div class="jp">' + escapeHtml(s.jp) + '</div>' +
              '<div class="sub">' + escapeHtml(s.kr||"") + '</div>' +
              '<div class="row" style="margin-top:10px;">' +
                '<button class="btn" onclick=\'speakJP(' + JSON.stringify(s.jp) + ')\'>' +
                  '문장 듣기' +
                '</button>' +
              '</div>' +
            '</div>'
          ).join("") +
        '</div>' +
      '</div>'
    ).join("") +
    '</div>';
}

function buildMCQ(obj){
  const prompt = obj.prompt;
  const correct = obj.correct;
  const pool = obj.pool || [];
  const explain = obj.explain || "";

  const wrongs = shuffle(pool.filter(x => x !== correct)).slice(0,3);
  const choices = shuffle([correct].concat(wrongs));
  const id = "q_" + Math.random().toString(16).slice(2);
  return { id, prompt, correct, choices, explain };
}

function renderReview(){
  todayPill.textContent = "복습: 최근 5일";
  const hist = loadJSON(LS_HISTORY_KEY, {});
  const days = getRecentDays(5);
  const ks = uniq([].concat.apply([], days.map(d => hist[d] || []))).filter(Boolean);

  if (ks.length === 0){
    view.innerHTML =
      '<div class="card">' +
        '<div class="q">복습 데이터가 없습니다.</div>' +
        '<div class="muted">학습 탭에 들어가면 오늘 세트가 자동 기록됩니다.</div>' +
      '</div>';
    return;
  }

  const meaningPool = KANJI_DB.map(x => x.m).filter(Boolean);
  const choicePool = KANJI_DB.map(x => "（"+x.k+"）");

  const quiz = [];
  ks.forEach(k => {
    const item = lookupByK(k);
    if (!item) return;

    quiz.push(buildMCQ({
      prompt: "다음 한자의 의미로 가장 가까운 것은? — 「" + item.k + "」",
      correct: item.m,
      pool: meaningPool,
      explain: "음독/훈독도 같이 눈으로 확인하세요."
    }));

    const c = (item.cloze||[])[0];
    if (c){
      quiz.push(buildMCQ({
        prompt: "【파트5】다음 문장의 ( )에 들어갈 것은?\n" + c.q,
        correct: c.a,
        pool: (c.choices && c.choices.length) ? c.choices : choicePool,
        explain: c.kr || ""
      }));
    }
  });

  const finalQuiz = shuffle(quiz).slice(0, 10);

  view.innerHTML =
    '<div class="card">' +
      '<div class="q">최근 5일 복습 퀴즈</div>' +
      '<div class="muted">대상 날짜: ' + days.join(", ") + '</div>' +
    '</div>' +
    '<div class="card quizBox" id="quizBox"></div>';

  const box = document.getElementById("quizBox");
  box.innerHTML = finalQuiz.map((q, idx) =>
    '<div class="item" style="background:#fff;">' +
      '<div class="q">Q' + (idx+1) + '. ' + escapeHtml(q.prompt) + '</div>' +
      '<div class="choices">' +
        q.choices.map(ch =>
          '<button class="choice" data-qid="' + q.id + '" data-choice="' + escapeAttr(ch) + '">' +
            escapeHtml(ch) +
          '</button>'
        ).join("") +
      '</div>' +
      '<div class="muted" id="' + q.id + '_exp" style="display:none; margin-top:8px;"></div>' +
    '</div>'
  ).join("");

  box.querySelectorAll(".choice").forEach(btn => {
    btn.addEventListener("click", () => {
      const qid = btn.dataset.qid;
      const choice = btn.dataset.choice;
      const q = finalQuiz.find(x=>x.id===qid);
      if (!q) return;

      box.querySelectorAll('.choice[data-qid="' + qid + '"]').forEach(b => b.disabled = true);

      box.querySelectorAll('.choice[data-qid="' + qid + '"]').forEach(b => {
        const c = b.dataset.choice;
        if (c === q.correct) b.classList.add("correct");
        if (c === choice && c !== q.correct) b.classList.add("wrong");
      });

      const exp = document.getElementById(qid + "_exp");
      exp.style.display = "block";
      exp.innerHTML = "정답: <b>" + escapeHtml(q.correct) + "</b> · " + escapeHtml(q.explain || "");
    });
  });
}

function renderPart5(){
  todayPill.textContent = "파트5: 오늘 세트 기반";
  const ks = getTodaySet();
  const items = ks.map(lookupByK).filter(Boolean);

  const qs = shuffle([].concat.apply([], items.map(x => x.cloze || []))).slice(0, 6);
  if (qs.length === 0){
    view.innerHTML =
      '<div class="card">' +
        '<div class="q">파트5 문제 데이터가 없습니다.</div>' +
      '</div>';
    return;
  }

  const compiled = qs.map(x => buildMCQ({
    prompt: x.q,
    correct: x.a,
    pool: (x.choices && x.choices.length) ? x.choices : ["（？）"],
    explain: x.kr || ""
  }));

  view.innerHTML =
    '<div class="card">' +
      '<div class="q">JPT 파트5 스타일 빈칸</div>' +
      '<div class="muted">오늘 3한자에서 생성됩니다.</div>' +
    '</div>' +
    '<div class="card quizBox" id="p5Box"></div>';

  const p5Box = document.getElementById("p5Box");
  p5Box.innerHTML = compiled.map((q, idx) => {
    const ttsText = q.prompt.split("（　）").join("＿＿");
    return (
      '<div class="item" style="background:#fff;">' +
        '<div class="q">Q' + (idx+1) + '. ' + escapeHtml(q.prompt) + '</div>' +
        '<div class="choices">' +
          q.choices.map(ch =>
            '<button class="choice" data-qid="' + q.id + '" data-choice="' + escapeAttr(ch) + '">' +
              escapeHtml(ch) +
            '</button>'
          ).join("") +
        '</div>' +
        '<div class="row" style="margin-top:10px;">' +
          '<button class="btn" onclick=\'speakJP(' + JSON.stringify(ttsText) + ')\'>' +
            '문장 듣기' +
          '</button>' +
          '<span class="muted">※ 빈칸은 ‘＿＿’로 읽힙니다</span>' +
        '</div>' +
        '<div class="muted" id="' + q.id + '_exp" style="display:none; margin-top:8px;"></div>' +
      '</div>'
    );
  }).join("");

  p5Box.querySelectorAll(".choice").forEach(btn => {
    btn.addEventListener("click", () => {
      const qid = btn.dataset.qid;
      const choice = btn.dataset.choice;
      const q = compiled.find(x=>x.id===qid);
      if (!q) return;

      p5Box.querySelectorAll('.choice[data-qid="' + qid + '"]').forEach(b => b.disabled = true);

      p5Box.querySelectorAll('.choice[data-qid="' + qid + '"]').forEach(b => {
        const c = b.dataset.choice;
        if (c === q.correct) b.classList.add("correct");
        if (c === choice && c !== q.correct) b.classList.add("wrong");
      });

      const exp = document.getElementById(qid + "_exp");
      exp.style.display = "block";
      exp.innerHTML = "정답: <b>" + escapeHtml(q.correct) + "</b> · " + escapeHtml(q.explain || "");
    });
  });
}

function renderSettings(){
  todayPill.textContent = "설정";
  const hist = loadJSON(LS_HISTORY_KEY, {});
  const days = Object.keys(hist).sort().reverse();
  const total = days.reduce((acc, d) => acc + (hist[d] ? hist[d].length : 0), 0);

  view.innerHTML =
    '<div class="card">' +
      '<div class="q">기록 관리</div>' +
      '<div class="muted">기록된 날짜: ' + days.length + '일 · 누적 기록(중복 포함): ' + total + '개</div>' +
      '<div class="row" style="margin-top:12px;">' +
        '<button class="btn secondary" id="clearBtn">기록 초기화</button>' +
      '</div>' +
    '</div>';

  document.getElementById("clearBtn").onclick = () => {
    if (!confirm("학습 기록을 전부 삭제할까요?")) return;
    localStorage.removeItem(LS_HISTORY_KEY);
    localStorage.removeItem(LS_OVERRIDE_KEY);
    alert("삭제 완료");
    setTab("learn");
  };
}

/* =========================
   6) 탭 / 이벤트
   ========================= */
function setTab(name){
  document.querySelectorAll(".tab").forEach(t=>{
    t.classList.toggle("active", t.dataset.tab === name);
  });
  if (name === "learn") renderLearn();
  if (name === "review") renderReview();
  if (name === "part5") renderPart5();
  if (name === "settings") renderSettings();
}

document.querySelectorAll(".tab").forEach(t => {
  t.addEventListener("click", () => setTab(t.dataset.tab));
});

document.getElementById("regenBtn").onclick = () => {
  const dateKey = kstDateKey(0);
  const ks = regenTodayRandom();
  alert(dateKey + " 세트(랜덤)로 변경: " + ks.join(", "));
  setTab("learn");
};

document.getElementById("ttsBtn").onclick = () => {
  speakJP("本日はよろしくお願いいたします。");
};

/* 최초 로드: 버튼 안 눌러도 오늘 3개 자동 표시 */
setTab("learn");
</script>
</body>
</html>
