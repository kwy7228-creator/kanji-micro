<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Kanji Micro · 200 (JPT 750)</title>
  <style>
    :root { color-scheme: light; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans JP", sans-serif; background:#f7f5f2; color:#141821; }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 18px; }
    header { display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between; }
    h1 { margin:0; font-size:18px; }
    .muted { color:#6b7280; font-size:12px; line-height:1.4; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .pill { font-size:12px; padding:6px 10px; border:1px solid #e1dbd3; border-radius:999px; background:#fff; }
    .btn { border:0; padding:10px 12px; border-radius:10px; background:#2f6fed; color:#fff; cursor:pointer; font-weight:800; }
    .btn.secondary { background:#111827; }
    .btn.ghost { background:#fff; color:#111827; border:1px solid #d9d2c8; }
    .btn:disabled { opacity:.5; cursor:not-allowed; }

    .tabs { display:flex; gap:8px; flex-wrap:wrap; margin-top:12px; }
    .tab { border:1px solid #d9d2c8; background:#fff; padding:8px 10px; border-radius:10px; cursor:pointer; font-weight:800; }
    .tab.active { background:#1f2937; color:#fff; border-color:#1f2937; }

    .grid { display:grid; grid-template-columns: 1fr; gap:14px; margin-top:14px; }
    @media (min-width: 920px){ .grid { grid-template-columns: 1fr 1fr; } }

    .card { background:#fff; border:1px solid #e6dfd7; border-radius:14px; padding:16px; box-shadow: 0 6px 18px rgba(0,0,0,.06); }
    .kanjiRow { display:flex; gap:14px; align-items:flex-end; flex-wrap:wrap; }
    .kanji { font-size:64px; line-height:1; font-weight:900; }
    .meta { display:flex; flex-direction:column; gap:6px; }
    .meta .small { font-size:12px; color:#5a6475; }

    .section { margin-top: 12px; display:grid; gap:10px; }
    .label { font-size:12px; color:#6b7280; font-weight:900; letter-spacing:.08em; text-transform: uppercase; }
    .item { background:#fbfaf8; border:1px solid #eee7df; border-radius:12px; padding:10px 12px; }
    .jp { font-size:15px; font-weight:900; }
    .sub { font-size:13px; color:#4b5563; margin-top:4px; }

    .quizBox { display:grid; gap:12px; }
    .q { font-weight:900; white-space:pre-wrap; }
    .choices { display:grid; gap:8px; margin-top:8px; }
    .choice { text-align:left; background:#fff; border:1px solid #e6dfd7; padding:10px 12px; border-radius:10px; cursor:pointer; font-weight:900; }
    .choice.correct { border-color:#16a34a; outline:2px solid rgba(22,163,74,.2); }
    .choice.wrong { border-color:#dc2626; outline:2px solid rgba(220,38,38,.2); }

    code { background:#f3f4f6; padding:2px 6px; border-radius:6px; }
    .footer { margin-top: 16px; font-size:12px; color:#6b7280; line-height:1.5; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Kanji Micro · 200 (JPT 750)</h1>
        <div class="muted">한자 → 단어(요미+뜻) → 단어 포함 문장 → 문장 듣기 · 최근 5일 복습 · 파트5</div>
      </div>
      <div class="row">
        <span id="todayPill" class="pill"></span>
        <button id="regenBtn" class="btn">오늘 3개(랜덤) 다시뽑기</button>
        <button id="ttsBtn" class="btn ghost">TTS 테스트</button>
      </div>
    </header>

    <div class="tabs">
      <button class="tab active" data-tab="learn">학습</button>
      <button class="tab" data-tab="review">복습(최근 5일)</button>
      <button class="tab" data-tab="part5">파트5 빈칸</button>
      <button class="tab" data-tab="settings">설정</button>
    </div>

    <main id="view"></main>

    <div class="footer">
      - “더미 단어/문장”은 절대 출력하지 않도록 설계했습니다(단어 데이터 없는 한자는 출제 제외).<br/>
      - 기록은 브라우저 <code>localStorage</code>에 저장됩니다.
    </div>
  </div>

<script>
/* =========================
   0) 유틸
   ========================= */
function uniq(arr){ return Array.from(new Set(arr)); }
function shuffle(arr){
  const a = arr.slice();
  for (let i=a.length-1; i>0; i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}
function escapeHtml(str){
  return String(str)
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;")
    .replace(/'/g,"&#039;");
}
function escapeAttr(str){ return escapeHtml(str).replace(/"/g,"&quot;"); }

/* =========================
   1) 한자 기본정보 (필수: m=의미)
   ========================= */
const KANJI_INFO = {
  "率":{on:"ソツ/リツ",kun:"—",m:"비율, 율"},
  "比":{on:"ヒ",kun:"くら(べる)",m:"비교하다/비"},
  "較":{on:"カク",kun:"—",m:"비교(較)"},
  "定":{on:"テイ",kun:"—",m:"정하다"},
  "認":{on:"ニン",kun:"—",m:"확인/인정"},
  "説":{on:"セツ",kun:"—",m:"설명"},
  "題":{on:"ダイ",kun:"—",m:"제목/문제"},
  "問":{on:"モン",kun:"と(う)",m:"질문/문제"},
  "答":{on:"トウ",kun:"こた(える)",m:"대답"},
  "空":{on:"クウ",kun:"そら/あ(く)",m:"하늘/비다"},
  "天":{on:"テン",kun:"あま",m:"하늘"},
  // 필요시 계속 추가(200까지 확장 가능)
};

/* =========================
   2) 단어 뱅크 (필수: jp + y(요미) + kr(뜻))
   - 여기 있는 한자만 오늘 출제 후보가 됩니다.
   ========================= */
const WORD_BANK = {
  "率": [
    { jp:"確率", y:"かくりつ", kr:"확률" },
    { jp:"比率", y:"ひりつ", kr:"비율" }
  ],
  "比": [
    { jp:"比較", y:"ひかく", kr:"비교" },
    { jp:"比率", y:"ひりつ", kr:"비율" }
  ],
  "較": [
    { jp:"比較", y:"ひかく", kr:"비교" },
    { jp:"比較的", y:"ひかくてき", kr:"비교적" }
  ],
  "定": [
    { jp:"決定", y:"けってい", kr:"결정" },
    { jp:"予定", y:"よてい", kr:"예정" }
  ],
  "認": [
    { jp:"確認", y:"かくにん", kr:"확인" },
    { jp:"承認", y:"しょうにん", kr:"승인" }
  ],
  "説": [
    { jp:"説明", y:"せつめい", kr:"설명" },
    { jp:"解説", y:"かいせつ", kr:"해설" }
  ],
  "題": [
    { jp:"問題", y:"もんだい", kr:"문제" },
    { jp:"宿題", y:"しゅくだい", kr:"숙제" }
  ],
  "問": [
    { jp:"質問", y:"しつもん", kr:"질문" },
    { jp:"問題", y:"もんだい", kr:"문제" }
  ],
  "答": [
    { jp:"回答", y:"かいとう", kr:"답변" },
    { jp:"答え", y:"こたえ", kr:"정답/답" }
  ],
  "空": [
    { jp:"空港", y:"くうこう", kr:"공항" },
    { jp:"空席", y:"くうせき", kr:"빈자리" }
  ],
  "天": [
    { jp:"天気", y:"てんき", kr:"날씨" },
    { jp:"天国", y:"てんごく", kr:"천국" }
  ],
};

/* =========================
   3) 문장 생성 (핵심: 단어가 문장에 반드시 포함)
   - 단어 유형별로 “어색함”을 줄이기 위한 최소 규칙
   ========================= */
function buildSentencesFromWord(w){
  // 기본: 업무/시험에도 무난한 2문장
  const s1 = { jp: w.jp + "は重要です。", kr: w.kr + "는/은 중요합니다." };
  const s2 = { jp: w.jp + "について説明します。", kr: w.kr + "에 대해 설명하겠습니다." };

  // 일부 단어는 자연 문장 보정
  if (w.jp.endsWith("曜日")){
    return [
      { jp: w.jp + "は会議があります。", kr: w.kr + "에는 회의가 있습니다." },
      { jp: w.jp + "の予定を確認します。", kr: w.kr + " 일정을 확인합니다." }
    ];
  }
  if (w.jp === "空港"){
    return [
      { jp: "空港まで電車で行きます。", kr: "공항까지 전철로 갑니다." },
      { jp: "空港で友達を待ちます。", kr: "공항에서 친구를 기다립니다." }
    ];
  }
  if (w.jp === "天気"){
    return [
      { jp: "今日は天気がいいです。", kr: "오늘은 날씨가 좋습니다." },
      { jp: "天気予報を見ました。", kr: "일기예보를 봤습니다." }
    ];
  }
  return [s1, s2];
}

/* =========================
   4) 엔트리 생성
   ========================= */
function buildEntry(k){
  const info = KANJI_INFO[k] || {on:"-",kun:"-",m:"-"};
  const words = (WORD_BANK[k] || []).slice(0,2);

  // 안전장치: 단어 없으면 엔트리 생성 자체를 막음
  if (!words.length) return null;

  // 첫 단어로 문장 생성
  const sentences = buildSentencesFromWord(words[0]);

  // Part5: 첫 문장을 빈칸으로
  const base = sentences[0];
  const clozeQ = base.jp.replace(words[0].jp, "（　）");
  const correct = "（" + words[0].jp + "）";

  // 오답: 다른 단어들에서 뽑음
  const allWords = Object.values(WORD_BANK).flat().map(x=>x.jp);
  const wrongs = shuffle(allWords.filter(x => x !== words[0].jp)).slice(0,3).map(x=>"（"+x+"）");
  const choices = shuffle([correct, ...wrongs]).slice(0,4);

  return {
    k,
    y_on: info.on,
    y_kun: info.kun,
    m: info.m,
    words,
    sentences,
    cloze: [{ q: clozeQ, a: correct, choices, kr: base.kr }]
  };
}

/* “출제 가능한 한자”만 리스트로 사용 */
const KANJI_LIST = Object.keys(WORD_BANK);
const KANJI_DB = KANJI_LIST.map(buildEntry).filter(Boolean);
function lookupByK(k){ return KANJI_DB.find(x=>x.k===k); }

/* =========================
   5) 날짜 기반 오늘 3개(고정) + 기록
   ========================= */
const LS_HISTORY_KEY = "KANJI_APP_HISTORY_V4";
const LS_OVERRIDE_KEY = "KANJI_APP_OVERRIDE_V3";

function kstDateKey(offsetDays=0){
  const now = new Date();
  const utc = now.getTime() + now.getTimezoneOffset()*60000;
  const kst = new Date(utc + 9*3600000);
  kst.setDate(kst.getDate() + offsetDays);
  const y = kst.getFullYear();
  const m = String(kst.getMonth()+1).padStart(2,"0");
  const d = String(kst.getDate()).padStart(2,"0");
  return y + "-" + m + "-" + d;
}
function loadJSON(key, fallback){
  try { return JSON.parse(localStorage.getItem(key) || JSON.stringify(fallback)); }
  catch { return fallback; }
}
function saveJSON(key, obj){ localStorage.setItem(key, JSON.stringify(obj)); }
function hash32(str){
  let h = 2166136261;
  for (let i=0; i<str.length; i++){
    h ^= str.charCodeAt(i);
    h = Math.imul(h, 16777619);
  }
  return h >>> 0;
}
function seededPick3(dateKey){
  const seed = hash32(dateKey);
  const idxs = [];
  const n = KANJI_LIST.length;
  let x = seed || 1;
  while (idxs.length < Math.min(3,n)){
    x ^= x << 13; x >>>= 0;
    x ^= x >> 17; x >>>= 0;
    x ^= x << 5;  x >>>= 0;
    const idx = x % n;
    if (!idxs.includes(idx)) idxs.push(idx);
  }
  return idxs.map(i => KANJI_LIST[i]);
}
function saveStudyHistory(dateKey, ks){
  const hist = loadJSON(LS_HISTORY_KEY, {});
  hist[dateKey] = ks;
  saveJSON(LS_HISTORY_KEY, hist);
}
function getTodaySet(){
  const dateKey = kstDateKey(0);
  const override = loadJSON(LS_OVERRIDE_KEY, {});
  if (override[dateKey] && Array.isArray(override[dateKey]) && override[dateKey].length){
    saveStudyHistory(dateKey, override[dateKey]);
    return override[dateKey];
  }
  const ks = seededPick3(dateKey);
  saveStudyHistory(dateKey, ks);
  return ks;
}
function regenTodayRandom(){
  const dateKey = kstDateKey(0);
  const ks = shuffle(KANJI_LIST).slice(0, Math.min(3, KANJI_LIST.length));
  const override = loadJSON(LS_OVERRIDE_KEY, {});
  override[dateKey] = ks;
  saveJSON(LS_OVERRIDE_KEY, override);
  saveStudyHistory(dateKey, ks);
  return ks;
}
function getRecentDays(n=5){
  const keys = [];
  for (let i=0; i<n; i++) keys.push(kstDateKey(-i));
  return keys;
}

/* =========================
   6) TTS
   ========================= */
function speakJP(text){
  if (!("speechSynthesis" in window)) { alert("이 브라우저는 TTS를 지원하지 않습니다."); return; }
  const u = new SpeechSynthesisUtterance(text);
  u.lang = "ja-JP";
  window.speechSynthesis.cancel();
  window.speechSynthesis.speak(u);
}
window.speakJP = speakJP;

/* =========================
   7) 렌더
   ========================= */
const view = document.getElementById("view");
const todayPill = document.getElementById("todayPill");

function renderLearn(){
  const dateKey = kstDateKey(0);
  todayPill.textContent = "오늘: " + dateKey + " · 3한자(단어 있는 것만)";

  const ks = getTodaySet();
  const items = ks.map(lookupByK).filter(Boolean);

  if (!items.length){
    view.innerHTML = '<div class="card"><div class="q">표시할 데이터가 없습니다.</div><div class="muted">WORD_BANK에 단어를 먼저 추가하세요.</div></div>';
    return;
  }

  view.innerHTML =
    '<div class="grid">' +
    items.map(item => {
      const wordsHtml = (item.words||[]).map(w =>
        '<div class="item">' +
          '<div class="jp">' + escapeHtml(w.jp) + '（' + escapeHtml(w.y) + '）</div>' +
          '<div class="sub">' + escapeHtml(w.kr) + '</div>' +
        '</div>'
      ).join("");

      const sentHtml = (item.sentences||[]).slice(0,2).map(s =>
        '<div class="item">' +
          '<div class="jp">' + escapeHtml(s.jp) + '</div>' +
          '<div class="sub">' + escapeHtml(s.kr) + '</div>' +
          '<div class="row" style="margin-top:10px;">' +
            '<button class="btn" onclick=\'speakJP(' + JSON.stringify(s.jp) + ')\'>' +
              '문장 듣기' +
            '</button>' +
          '</div>' +
        '</div>'
      ).join("");

      return (
        '<div class="card">' +
          '<div class="kanjiRow">' +
            '<div class="kanji">' + escapeHtml(item.k) + '</div>' +
            '<div class="meta">' +
              '<div class="small"><b>음독</b> ' + escapeHtml(item.y_on||"-") + '</div>' +
              '<div class="small"><b>훈독</b> ' + escapeHtml(item.y_kun||"-") + '</div>' +
              '<div class="small"><b>의미</b> ' + escapeHtml(item.m||"-") + '</div>' +
            '</div>' +
          '</div>' +

          '<div class="section"><div class="label">단어</div>' + wordsHtml + '</div>' +
          '<div class="section"><div class="label">문장</div>' + sentHtml + '</div>' +
        '</div>'
      );
    }).join("") +
    '</div>';
}

function buildMCQ(obj){
  const prompt = obj.prompt;
  const correct = obj.correct;
  const pool = obj.pool || [];
  const explain = obj.explain || "";
  const wrongs = shuffle(pool.filter(x => x !== correct)).slice(0,3);
  const choices = shuffle([correct].concat(wrongs)).slice(0,4);
  const id = "q_" + Math.random().toString(16).slice(2);
  return { id, prompt, correct, choices, explain };
}

function renderReview(){
  todayPill.textContent = "복습: 최근 5일";
  const hist = loadJSON(LS_HISTORY_KEY, {});
  const days = getRecentDays(5);
  const ks = uniq([].concat.apply([], days.map(d => hist[d] || []))).filter(Boolean);

  if (!ks.length){
    view.innerHTML = '<div class="card"><div class="q">복습 데이터가 없습니다.</div><div class="muted">학습 탭을 열면 오늘 세트가 자동 기록됩니다.</div></div>';
    return;
  }

  const meaningPool = KANJI_DB.map(x => x.m).filter(Boolean);
  const wordChoices = Object.values(WORD_BANK).flat().map(w=>"（"+w.jp+"）");

  const quiz = [];
  ks.forEach(k => {
    const item = lookupByK(k);
    if (!item) return;

    quiz.push(buildMCQ({
      prompt: "다음 한자의 의미로 가장 가까운 것은? — 「" + item.k + "」",
      correct: item.m,
      pool: meaningPool,
      explain: "단어/문장도 같이 확인하세요."
    }));

    const c = (item.cloze||[])[0];
    if (c){
      quiz.push(buildMCQ({
        prompt: "【파트5】다음 문장의 ( )에 들어갈 것은?\n" + c.q,
        correct: c.a,
        pool: c.choices && c.choices.length ? c.choices : wordChoices,
        explain: c.kr || ""
      }));
    }
  });

  const finalQuiz = shuffle(quiz).slice(0, 10);

  view.innerHTML =
    '<div class="card"><div class="q">최근 5일 복습 퀴즈</div><div class="muted">대상 날짜: ' + days.join(", ") + '</div></div>' +
    '<div class="card quizBox" id="quizBox"></div>';

  const box = document.getElementById("quizBox");
  box.innerHTML = finalQuiz.map((q, idx) =>
    '<div class="item" style="background:#fff;">' +
      '<div class="q">Q' + (idx+1) + '. ' + escapeHtml(q.prompt) + '</div>' +
      '<div class="choices">' +
        q.choices.map(ch =>
          '<button class="choice" data-qid="' + q.id + '" data-choice="' + escapeAttr(ch) + '">' + escapeHtml(ch) + '</button>'
        ).join("") +
      '</div>' +
      '<div class="muted" id="' + q.id + '_exp" style="display:none; margin-top:8px;"></div>' +
    '</div>'
  ).join("");

  box.querySelectorAll(".choice").forEach(btn => {
    btn.addEventListener("click", () => {
      const qid = btn.dataset.qid;
      const choice = btn.dataset.choice;
      const q = finalQuiz.find(x=>x.id===qid);
      if (!q) return;

      box.querySelectorAll('.choice[data-qid="' + qid + '"]').forEach(b => b.disabled = true);
      box.querySelectorAll('.choice[data-qid="' + qid + '"]').forEach(b => {
        const c = b.dataset.choice;
        if (c === q.correct) b.classList.add("correct");
        if (c === choice && c !== q.correct) b.classList.add("wrong");
      });

      const exp = document.getElementById(qid + "_exp");
      exp.style.display = "block";
      exp.innerHTML = "정답: <b>" + escapeHtml(q.correct) + "</b> · " + escapeHtml(q.explain || "");
    });
  });
}

function renderPart5(){
  todayPill.textContent = "파트5: 오늘 세트 기반";
  const ks = getTodaySet();
  const items = ks.map(lookupByK).filter(Boolean);
  const qs = shuffle([].concat.apply([], items.map(x => x.cloze || []))).slice(0, 6);

  if (!qs.length){
    view.innerHTML = '<div class="card"><div class="q">파트5 문제 데이터가 없습니다.</div></div>';
    return;
  }

  const compiled = qs.map(x => buildMCQ({
    prompt: x.q,
    correct: x.a,
    pool: x.choices,
    explain: x.kr || ""
  }));

  view.innerHTML =
    '<div class="card"><div class="q">JPT 파트5 스타일 빈칸</div><div class="muted">오늘 3한자에서 생성됩니다.</div></div>' +
    '<div class="card quizBox" id="p5Box"></div>';

  const p5Box = document.getElementById("p5Box");
  p5Box.innerHTML = compiled.map((q, idx) => {
    const ttsText = q.prompt.split("（　）").join("＿＿");
    return (
      '<div class="item" style="background:#fff;">' +
        '<div class="q">Q' + (idx+1) + '. ' + escapeHtml(q.prompt) + '</div>' +
        '<div class="choices">' +
          q.choices.map(ch =>
            '<button class="choice" data-qid="' + q.id + '" data-choice="' + escapeAttr(ch) + '">' + escapeHtml(ch) + '</button>'
          ).join("") +
        '</div>' +
        '<div class="row" style="margin-top:10px;">' +
          '<button class="btn" onclick=\'speakJP(' + JSON.stringify(ttsText) + ')\'>' + '문장 듣기' + '</button>' +
          '<span class="muted">※ 빈칸은 ‘＿＿’로 읽힙니다</span>' +
        '</div>' +
        '<div class="muted" id="' + q.id + '_exp" style="display:none; margin-top:8px;"></div>' +
      '</div>'
    );
  }).join("");

  p5Box.querySelectorAll(".choice").forEach(btn => {
    btn.addEventListener("click", () => {
      const qid = btn.dataset.qid;
      const choice = btn.dataset.choice;
      const q = compiled.find(x=>x.id===qid);
      if (!q) return;

      p5Box.querySelectorAll('.choice[data-qid="' + qid + '"]').forEach(b => b.disabled = true);
      p5Box.querySelectorAll('.choice[data-qid="' + qid + '"]').forEach(b => {
        const c = b.dataset.choice;
        if (c === q.correct) b.classList.add("correct");
        if (c === choice && c !== q.correct) b.classList.add("wrong");
      });

      const exp = document.getElementById(qid + "_exp");
      exp.style.display = "block";
      exp.innerHTML = "정답: <b>" + escapeHtml(q.correct) + "</b> · " + escapeHtml(q.explain || "");
    });
  });
}

function renderSettings(){
  todayPill.textContent = "설정";
  const hist = loadJSON(LS_HISTORY_KEY, {});
  const days = Object.keys(hist).sort().reverse();
  const total = days.reduce((acc, d) => acc + (hist[d] ? hist[d].length : 0), 0);

  view.innerHTML =
    '<div class="card">' +
      '<div class="q">기록 관리</div>' +
      '<div class="muted">기록된 날짜: ' + days.length + '일 · 누적 기록(중복 포함): ' + total + '개</div>' +
      '<div class="row" style="margin-top:12px;">' +
        '<button class="btn secondary" id="clearBtn">기록 초기화</button>' +
      '</div>' +
    '</div>';

  document.getElementById("clearBtn").onclick = () => {
    if (!confirm("학습 기록을 전부 삭제할까요?")) return;
    localStorage.removeItem(LS_HISTORY_KEY);
    localStorage.removeItem(LS_OVERRIDE_KEY);
    alert("삭제 완료");
    setTab("learn");
  };
}

function setTab(name){
  document.querySelectorAll(".tab").forEach(t=> t.classList.toggle("active", t.dataset.tab === name));
  if (name === "learn") renderLearn();
  if (name === "review") renderReview();
  if (name === "part5") renderPart5();
  if (name === "settings") renderSettings();
}
document.querySelectorAll(".tab").forEach(t => t.addEventListener("click", () => setTab(t.dataset.tab)));
document.getElementById("regenBtn").onclick = () => { regenTodayRandom(); setTab("learn"); };
document.getElementById("ttsBtn").onclick = () => { speakJP("本日はよろしくお願いいたします。"); };

setTab("learn");
</script>
</body>
</html>
